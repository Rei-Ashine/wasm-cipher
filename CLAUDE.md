# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a WebAssembly-based encryption tool that provides AES-256-CBC encryption/decryption functionality through a web interface. The project uses Rust for cryptographic operations (compiled to WebAssembly) and JavaScript for the frontend.

## Architecture

The project consists of two main components:

1. **Rust/WebAssembly Core** (`/src/`)
   - `lib.rs`: WASM bindings exposing `encrypt` and `decrypt` functions with error handling
   - `cipher.rs`: Secure AES encryption/decryption implementation using:
     - AES-256 encryption with CBC mode
     - PBKDF2-HMAC-SHA256 for secure key derivation (100,000 iterations)
     - Random per-encryption salts (16 bytes)
     - Random initialization vectors (16 bytes)
     - Base64 encoding for output
     - Proper error handling (no panics)

2. **Web Frontend** (`/www/`)
   - Modern JavaScript application with proper error handling
   - Bootstrap 5.3.6 UI framework (updated for security)
   - Webpack 5.95+ for bundling and WebAssembly integration
   - Modern Clipboard API with fallback support
   - Input validation and user feedback

## Security Improvements (Updated 2025)

### Cryptographic Security
- **PBKDF2 Key Derivation**: Uses 100,000 iterations with random salts
- **Random IVs**: Each encryption uses a unique initialization vector
- **No Hard-coded Secrets**: Removed fixed salt, uses random per-encryption salts
- **Proper Error Handling**: No panics that could leak information
- **Updated Crypto Libraries**: Modern, audited cryptographic dependencies

### Frontend Security
- **Input Validation**: Validates password and data before processing
- **Error Handling**: Graceful error messages without sensitive information
- **Modern APIs**: Uses Clipboard API instead of deprecated clipboard.js
- **Updated Dependencies**: Latest versions to patch security vulnerabilities

## Common Development Commands

### Testing

Run Rust unit tests (including crypto security tests):
```bash
cargo test
```

### Building the WebAssembly Module

First, ensure you have `wasm-pack` installed:
```bash
cargo install wasm-pack
```

Build the Rust code to WebAssembly:
```bash
wasm-pack build
```

This creates a `pkg/` directory with the generated WebAssembly module and JavaScript bindings.

### Frontend Development

Navigate to the www directory:
```bash
cd www
```

Install dependencies (will install updated versions):
```bash
npm install
```

Start development server:
```bash
npm start
```

Build for production:
```bash
npm run build
```

### Full Build Process

1. Run tests: `cargo test`
2. Build the WebAssembly module: `wasm-pack build`
3. Navigate to www: `cd www`
4. Install dependencies: `npm install`
5. Build frontend: `npm run build`

The final output will be in `www/dist/`

## Key Dependencies

### Rust (Updated for Security)
- **aes**: 0.8.4 (updated from 0.7.5)
- **sha2**: 0.10.9 (updated from 0.9.8)
- **base64**: 0.22.1 (updated from 0.13.0, major API changes)
- **wasm-bindgen**: 0.2.100 (updated from 0.2)
- **cbc**: 0.1 (replaces deprecated block-modes)
- **pbkdf2**: 0.12 (new dependency for secure key derivation)
- **getrandom**: 0.2 (with js feature for WebAssembly)
- **web-sys**: 0.3 (for console logging in WASM)

### JavaScript (Updated for Security)
- **webpack**: 5.95+ (updated from 5.75.0)
- **webpack-cli**: 6.0.1 (updated from 5.0.1)
- **webpack-dev-server**: 5.2.2 (updated from 4.11.1)
- **bootstrap**: 5.3.6 (updated from 5.2.3)

## Breaking Changes

### Cryptographic Format
⚠️ **Important**: The new encryption format is **incompatible** with the old version due to security improvements:
- Old format: `base64(IV + ciphertext)` with fixed salt
- New format: `base64(salt + IV + ciphertext)` with random salt per encryption

Data encrypted with the old version cannot be decrypted with the new version.

### API Changes
- Rust functions now return `Result<String, String>` instead of `String`
- JavaScript error handling improved with proper user feedback
- Removed deprecated clipboard.js dependency

## Important Notes

- The project uses `wasm-pack` to build Rust code into WebAssembly
- The `pkg/` directory (generated by wasm-pack) is referenced in `www/package.json` as a local dependency
- WebAssembly support is enabled in webpack via `experiments.syncWebAssembly`
- All cryptographic operations use secure random number generation
- Error messages are designed to not leak sensitive information
- The project includes privacy policy and terms of service pages in `www/public/html/`